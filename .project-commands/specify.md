# Specify Command - 需求分析与结构化

## 命令用途

`specify` 命令用于将用户的简单需求描述（可能是 bugfix、功能更改、新需求等）转化为结构化的开发需求文档，追加输出到 `.doc/dev.md` 文件中。

## 使用场景

- 用户提供简单的需求描述（可能包含多个不同方向的需求）
- 需求描述可能存在遗漏、不明确的地方
- 功能较大，需要拆解成多个子任务
- 需要生成结构化的开发需求文档，方便后续编程实现

## 执行流程

### 第一步：理解需求

1. **解析用户输入**
   - 识别用户描述中的多个需求点（可能用序号、换行、分号等分隔）
   - 区分需求类型：bugfix、功能更改、新功能、重构等
   - 识别涉及的技术栈：前端（main-web-ui）、后端（webserver）、全栈
   - **识别可拆分的需求**：
     - 如果需求包含多个可以独立完成的功能模块
     - 如果需求包含可以并行开发的部分
     - 如果需求规模较大，涉及多个不同的业务领域
     - 这些情况应该拆分成多个独立的需求，每个需求使用独立的 T-XXX 编号

2. **查看相关代码**
   - 根据需求描述中的关键词，搜索相关代码文件（如果存在，前后端代码都要查看，方便你进一步确定完整逻辑和约束）
   - 理解现有实现逻辑和架构
   - 识别可能受影响的模块和文件
   - 注意，前后端实现都要查看，代码已经明显体现出来的逻辑不要再询问用户

3. **识别不明确的地方**
   - 检查需求描述中缺失的信息：
     - 具体的功能细节
     - 边界情况处理
     - 错误处理方式
     - UI/UX 细节
     - 数据格式和 API 接口
   - 列出需要用户确认的问题

### 第二步：与用户确认

**⚠️ 严格禁止：必须等待用户确认完所有不明确的地方后才能进入下一步，绝对不能提前编写文档**

1. **提出澄清问题**
   - 以清晰、结构化的方式列出需要确认的问题
   - 每个问题应该：
     - 说明为什么需要确认（缺失的信息）
     - 提供可能的选项或建议
     - 询问用户的偏好
     - 给出推荐的回答

2. **等待用户回答**
   - 根据用户的回答更新需求理解
   - 如果仍有不明确的地方，继续询问
   - 确认所有不明确的地方都已得到用户明确回答后，才能进入第三步

### 第三步：需求拆解

1. **评估需求复杂度**
   - 判断需求是否需要拆分成多个**独立的需求**（而不是子任务）
   - 考虑因素：涉及的文件数量、功能模块的独立性、是否可以并行开发、业务领域的差异
   - **关键原则**：拆分后的需求可以存在依赖关系，如有依赖需在标题中标注

2. **拆分独立需求**
   - **何时拆分**：需求包含多个可以独立完成的功能模块、可以并行开发的部分、涉及不同业务领域或技术栈、包含多个不相关的 bugfix 或功能点
   - **拆分原则**：每个需求使用独立的 T-XXX 编号、有独立的 Checklist（从 C-001 开始），如存在依赖关系需在标题中标注 `(deps: T-xxx, T-xxx)`，**这很重要**
   - **不拆分的情况**：功能模块紧密耦合、拆分会增加复杂度、需求规模适中

### 第四步：生成结构化文档

1. **确定编号**
   - 读取 `.doc/dev.md` 文件（如果存在），查找最后一个任务编号（T-XXX）和 Checklist 编号（C-XXX）
   - 如果文件不存在或没有编号，从 T-001 和 C-001 开始
   - 如果文件存在，找到最后一个编号后递增：
     - 任务编号：T-001, T-002, T-003, ...
     - Checklist 编号：C-001, C-002, C-003, ...
   - 每个新需求使用新的任务编号，Checklist 从 C-001 开始重新计数

2. **处理链接和图片资源**
   - 识别用户描述中的链接（PR链接、文档链接等），在文档中引用
   - 识别用户描述中的图片，下载并保存到 `.doc/dev-images/` 目录（如果目录不存在则创建）
   - 图片命名规则：`T-XXX-{描述性名称}.{扩展名}`（如 `T-001-ui-design.png`）
   - 在文档的需求描述中引用链接和图片
   - 只处理对理解需求有帮助的资源，无关紧要的可以忽略

3. **确定相关指引**
   - 根据任务类型，确定需要参考的规则文档和代码位置
   - 按照以下分类组织：
     - **前端规则**：`.project-rules/frontend/` 下的规则文档路径及说明
     - **后端规则**：`.project-rules/backend/` 下的规则文档路径及说明
     - **前端Code Point**：`main-web-ui/` 下的相关代码文件路径
     - **前端路由**：前端路由路径
     - **后端Code Point**：`webserver/` 下的相关代码文件路径
     - **其他**：其他相关资源（API文档、第三方库等）

4. **识别注意点**
   - 可能存在的技术难点
   - 需要特别注意的边界情况
   - 可能影响的其他功能模块
   - 性能考虑
   - 兼容性要求

5. **生成 Checklist**
   - 根据需求内容，生成功能完成的检查表
   - 每个 Checklist 项应该：
     - 是功能完成的验证点
     - 有明确的验收标准
     - 覆盖主要功能点和边界情况
   - 使用编号格式：C-001, C-002, C-003, ...

6. **输出格式**

   追加到 `.doc/dev.md` 文件（如果文件不存在则创建），使用以下格式：

   **单个需求格式：**

   ```markdown
   # T-XXX 一句话简介
   # T-XXX 一句话简介 (deps: T-001, T-002)  # 如有依赖关系，在标题中标注
   
   ## 需求描述
   [详细描述需求背景、目标、功能点等]
   
   [如果有相关链接，可以在这里引用，如：]
   - 相关 PR: https://github.com/xxx/pull/123
   - 设计稿: https://figma.com/xxx
   
   [如果有相关图片，可以在这里引用，如：]
   ![UI设计图](.doc/dev-images/T-XXX-ui-design.png)
   
   ## 相关指引
   
   前端规则:
   - `.project-rules/frontend/architecture.md` - [一句话说明]
   - `.project-rules/frontend/workflow-bugfix.md` - [一句话说明]
   
   后端规则:
   - `.project-rules/backend/index.md` - [一句话说明]
   
   前端Code Point:
   - `main-web-ui/feature/xxx/` - [一句话说明]
   - `main-web-ui/component/xxx.tsx` - [一句话说明]
   
   前端路由:
   - `/workspace/projects` - [一句话说明]
   
   后端Code Point:
   - `webserver/api/xxx.py` - [一句话说明]
   
   其他:
   - [其他相关资源]
   
   ## 注意点
   - [可能的注意事项 1]
   - [可能的注意事项 2]
   - ...
   
   ## Checklist
   - [ ] C-001 [功能完成检查点 1]
   - [ ] C-002 [功能完成检查点 2]
   - [ ] C-003 [功能完成检查点 3]
   - ...
   ```

   **拆分后的多个需求：**

   如果需求被拆分成多个独立需求，每个需求使用独立的 T-XXX 编号，依次追加输出。每个需求的格式与单个需求格式相同，但使用不同的 T-XXX 编号，Checklist 从 C-001 重新开始计数。如存在依赖关系，需在标题中标注 `(deps: T-xxx, T-xxx)`。

## 输出示例

**示例1：单个需求（包含链接和图片）**

假设用户输入："修复用户列表页面的分页问题，并且添加搜索功能。参考这个PR：https://github.com/xxx/pull/123，设计图如下：[图片]"

输出到 `.doc/dev.md`：

```markdown
# T-001 修复用户列表分页并添加搜索功能

## 需求描述

1. **Bugfix：修复分页问题**
   - 当前用户列表页面的分页功能存在 bug，需要修复
   - 具体问题：[根据代码分析得出的具体问题]

2. **Feature：添加搜索功能**
   - 在用户列表页面添加搜索框
   - 支持按用户名、邮箱等字段搜索
   - 搜索结果需要支持分页

相关资源：
- 参考 PR: https://github.com/xxx/pull/123
- UI 设计图: ![UI设计图](.doc/dev-images/T-001-ui-design.png)

## 相关指引

前端规则:
- `.project-rules/frontend/architecture.md` - 了解 Manager/ViewController 架构
- `.project-rules/frontend/workflow-feature-update.md` - Feature Update 工作流程

前端Code Point:
- `main-web-ui/feature/user-list/` - 用户列表相关代码

前端路由:
- `/users` - 用户列表路由

## 注意点

- 搜索功能需要考虑性能优化，可能需要后端支持
- 分页修复需要确保不影响现有的筛选和排序功能
- 搜索和分页需要协同工作，搜索后重置分页到第一页

## Checklist

- [ ] C-001 分页功能正常工作，可以正确翻页
- [ ] C-002 搜索功能正常工作，可以按用户名、邮箱搜索
- [ ] C-003 搜索和分页可以协同工作，搜索结果支持分页
- [ ] C-004 搜索后重置分页到第一页
- [ ] C-005 分页修复不影响现有的筛选和排序功能
- [ ] C-006 边界情况处理正确（空搜索结果、单页结果等）
```

**示例2：拆分需求**

假设用户输入："修复用户列表页面的分页问题，并且优化广告创意管理页面的加载性能，还要添加新的导出功能"

如果识别到这些需求可以独立完成，可以拆分成多个需求：

输出到 `.doc/dev.md`：

```markdown
# T-001 修复用户列表分页问题

## 需求描述

**Bugfix：修复分页问题**
- 当前用户列表页面的分页功能存在 bug，需要修复
- 具体问题：[根据代码分析得出的具体问题]

## 相关指引

前端规则:
- `.project-rules/frontend/workflow-bugfix.md` - Bugfix 工作流程

前端Code Point:
- `main-web-ui/feature/user-list/` - 用户列表相关代码

前端路由:
- `/users` - 用户列表路由

## 注意点

- 分页修复需要确保不影响现有的筛选和排序功能

## Checklist

- [ ] C-001 分页功能正常工作，可以正确翻页
- [ ] C-002 分页修复不影响现有的筛选和排序功能
- [ ] C-003 边界情况处理正确（最后一页、空列表等）

# T-002 优化广告创意管理页面加载性能

## 需求描述

**Performance：优化页面加载性能**
- 广告创意管理页面加载较慢，需要优化
- 优化方向：[根据代码分析得出的优化点，如懒加载、代码分割、API 优化等]

## 相关指引

前端规则:
- `.project-rules/frontend/workflow-feature-update.md` - Feature Update 工作流程

前端Code Point:
- `main-web-ui/feature/creative-management/` - 广告创意管理相关代码

前端路由:
- `/creative-management` - 广告创意管理路由

## 注意点

- 优化需要确保不影响现有功能
- 需要考虑不同网络环境下的表现

## Checklist

- [ ] C-001 页面首次加载时间减少 X%
- [ ] C-002 优化后功能正常，无回归问题
- [ ] C-003 性能优化方案可维护

# T-003 添加导出功能

## 需求描述

**Feature：添加导出功能**
- 在广告创意管理页面添加导出功能
- 支持导出当前筛选结果
- 导出格式：[根据需求确定，如 CSV、Excel 等]

## 相关指引

前端规则:
- `.project-rules/frontend/workflow-feature-update.md` - Feature Update 工作流程

前端Code Point:
- `main-web-ui/feature/creative-management/` - 广告创意管理相关代码

前端路由:
- `/creative-management` - 广告创意管理路由

后端Code Point:
- `webserver/api/export.py` - 导出功能 API（如果需要后端支持）

## 注意点

- 导出功能需要考虑大数据量的处理
- 可能需要后端 API 支持

## Checklist

- [ ] C-001 导出功能正常工作
- [ ] C-002 支持导出当前筛选结果
- [ ] C-003 大数据量导出性能满足要求
- [ ] C-004 导出文件格式正确
```

## 注意事项

1. **⚠️ 用户确认优先（最重要）**：必须等待用户确认完所有不明确的地方后才能编写文档，不允许基于假设或推测直接编写文档

2. **追加模式**：始终追加内容到 `.doc/dev.md`，不要覆盖已有内容
3. **文件创建**：
   - 如果 `.doc/dev.md` 不存在，需要先创建 `.doc` 目录和文件
   - 如果用户描述中包含图片，需要创建 `.doc/dev-images/` 目录（如果不存在）
4. **编号规则**：
   - 任务编号（T-XXX）：每个新需求使用递增的任务编号，需要读取现有文件确定下一个编号
   - Checklist 编号（C-XXX）：每个需求的 Checklist 从 C-001 开始重新计数
   - 编号格式：T-001, T-002, T-003, ... 和 C-001, C-002, C-003, ...
   - **拆分需求**：如果需求被拆分成多个独立需求，每个需求使用独立的 T-XXX 编号，依次递增
   - **依赖关系**：拆分后的需求可以存在依赖关系，如有依赖需在标题中标注 `(deps: T-xxx, T-xxx)`
5. **格式统一**：保持输出格式的一致性，便于后续阅读和维护
6. **详细程度**：根据需求复杂度调整详细程度，简单需求可以简洁，复杂需求需要详细
7. **规则遵循**：生成的需求文档应该遵循项目的开发规范和架构原则
8. **需求导向**：输出的文档应该侧重于需求描述，不要添加代码层级细节的内容，可以包含 URL 链接（因为用户可以观察到）
9. **完整查看现有逻辑**: 如果有需要你应该同时查看前后端相关实现，来梳理现有逻辑

## 执行检查清单

在执行 specify 命令时，确保完成以下步骤：

- [ ] 解析用户输入，识别所有需求点和资源（链接、图片）
- [ ] 如果包含图片，下载并保存到 `.doc/dev-images/` 目录（使用 T-XXX 命名规则）
- [ ] 搜索并理解相关代码
- [ ] 识别不明确的地方，向用户提问并等待用户回答，确认所有不明确的地方都已得到明确回答后才能继续
- [ ] 评估需求复杂度，判断是否需要拆分成多个独立需求
- [ ] 读取 `.doc/dev.md` 确定下一个任务编号（T-XXX）
- [ ] 处理链接和图片资源（在文档中引用）
- [ ] 确定相关指引文档和代码路径
- [ ] 识别注意点和潜在风险
- [ ] 为每个需求生成详细的 Checklist（使用 C-001, C-002 等编号）
- [ ] 追加输出到 `.doc/dev.md`（格式正确，包含 T-XXX 和 C-XXX 编号）
- [ ] 确认输出内容完整且准确

