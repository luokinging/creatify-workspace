# Specify Command - 需求分析与结构化

## 命令用途

`specify` 命令用于将用户的简单需求描述（可能是 bugfix、功能更改、新需求等）转化为结构化的开发需求文档，追加输出到 `.doc/dev.md` 文件中。

## 使用场景

- 用户提供简单的需求描述（可能包含多个不同方向的需求）
- 需求描述可能存在遗漏、不明确的地方
- 功能较大，需要拆解成多个子任务
- 需要生成结构化的开发需求文档，方便后续编程实现

## 执行流程

### 第一步：理解需求

1. **解析用户输入**
   - 识别用户描述中的多个需求点（可能用序号、换行、分号等分隔）
   - 区分需求类型：bugfix、功能更改、新功能、重构等
   - 识别涉及的技术栈：前端（webserver/frontend）、后端（webserver/backend）、全栈
   - 识别可拆分的需求：多个独立功能模块、可并行开发的部分、不同业务领域等

2. **查看相关代码**
   - 根据需求描述中的关键词，搜索相关代码文件（前后端代码都要查看）
   - 理解现有实现逻辑和架构，识别可能受影响的模块和文件
   - 代码已经明显体现出来的逻辑不要再询问用户

3. **识别不明确的地方**
   - 检查需求描述中是否存在缺失的信息：功能细节、边界情况、错误处理、UI/UX 细节、数据格式和 API 接口等
   - 如果存在则列出需要用户确认的问题，并给出建议

### 第二步：与用户确认

**⚠️ 严格禁止：必须等待用户确认完所有不明确的地方后才能进入下一步，绝对不能提前编写文档**

1. **提出澄清问题**
   - 以清晰、结构化的方式列出需要确认的问题
   - 每个问题应该说明为什么需要确认、提供可能的选项或建议、给出推荐的回答

2. **等待用户回答**
   - 根据用户的回答更新需求理解
   - 如果仍有不明确的地方，继续询问
   - 确认所有不明确的地方都已得到用户明确回答后，才能进入第三步

### 第三步：需求拆解

1. **评估需求复杂度**
   - 判断需求是否需要拆分成多个**独立的需求**（而不是子任务）
   - 考虑因素：涉及的文件数量、功能模块的独立性、是否可以并行开发、业务领域的差异
   - **关键原则**：拆分后的需求可以存在依赖关系，如有依赖需在标题中标注

2. **拆分独立需求 - 核心原则**

   **⚠️ 重要：每个 Task 必须聚焦在一个单独的小功能上**
   
   - **何时拆分**：
     - 需求包含多个可以独立完成的功能模块
     - 需求包含可以并行开发的部分
     - 需求涉及不同业务领域或技术栈
     - 需求包含多个不相关的 bugfix 或功能点
     - **需求规模较大，需要按开发顺序逐步实现**（这是最重要的拆分场景）
   
   - **拆分原则**：
     - 每个需求使用独立的 T-XXX 编号
     - 有独立的 Checklist（从 C-001 开始）
     - 如存在依赖关系需在标题中标注 `(deps: T-xxx, T-xxx)`，**这很重要**
     - **按开发顺序拆解**：对于较大需求，必须按照开发顺序拆解成多个小任务
   
   - **按开发顺序拆解的典型场景**：
     - **新页面/新功能模块**：先创建路由和占位页面 → 实现页面跳转 → 实现页面基础布局 → 实现功能A → 实现功能B → 实现功能C
     - **新 API 接口**：先定义接口契约和数据结构 → 实现后端接口 → 实现前端调用 → 实现错误处理 → 实现边界情况
     - **复杂交互流程**：先实现基础流程 → 添加异常处理 → 添加优化和增强功能
     - **重构任务**：先创建新的结构 → 迁移部分功能 → 逐步替换旧实现 → 清理旧代码
   
   - **拆解粒度标准**：
     - 每个任务应该可以在 1-2 天内完成
     - 每个任务有明确的输入和输出
     - 每个任务完成后可以独立测试和验证
     - 任务之间可以存在依赖关系，但依赖关系要清晰明确
   
   - **不拆分的情况**：
     - 功能模块紧密耦合，拆分会增加复杂度
     - 需求规模适中，可以在一个任务内完成
     - 简单的 bugfix 或小的功能调整

### 第四步：生成结构化文档

1. **确定编号**
   - 读取 `.doc/dev.md` 文件，查找最后一个任务编号（T-XXX）
   - 如果文件不存在或没有编号，从 T-001 开始
   - 每个新需求使用新的任务编号，Checklist 从 C-001 开始重新计数

2. **处理链接和图片资源**
   - 识别用户描述中的链接和图片，在文档中引用
   - 图片下载并保存到 `.doc/dev-images/` 目录（如果目录不存在则创建）
   - 图片命名规则：`T-XXX-{描述性名称}.{扩展名}`
   - 只处理对理解需求有帮助的资源

3. **确定相关指引**
   - 根据任务类型，确定需要参考的规则文档和代码位置
   - 按照以下分类组织：前端规则、后端规则、前端Code Point、前端路由、后端Code Point、其他

4. **识别注意点**
   - 技术难点、边界情况、可能影响的其他功能模块、性能考虑、兼容性要求等

5. **生成 Checklist**
   - 根据需求内容，生成功能完成的检查表
   - 每个 Checklist 项应该是功能完成的验证点，有明确的验收标准，覆盖主要功能点和边界情况
   - 使用编号格式：C-001, C-002, C-003, ...

6. **输出格式**

   追加到 `.doc/dev.md` 文件（如果文件不存在则创建），使用以下格式：

   ```markdown
   # T-XXX 一句话简介
   # T-XXX 一句话简介 (deps: T-001, T-002)  # 如有依赖关系，在标题中标注
   
   ## 需求描述
   [详细描述需求背景、目标、功能点等]
   [可包含链接和图片引用]
   
   ## 相关指引
   前端规则: [规则文档路径及说明]
   后端规则: [规则文档路径及说明]
   前端Code Point: [代码文件路径及说明]
   前端路由: [路由路径及说明]
   后端Code Point: [代码文件路径及说明]
   其他: [其他相关资源]
   
   ## 注意点
   - [注意事项 1]
   - [注意事项 2]
   
   ## Checklist
   - [ ] C-001 [功能完成检查点 1]
   - [ ] C-002 [功能完成检查点 2]
   ```

   **拆分需求说明**：如果需求被拆分成多个独立需求，每个需求使用独立的 T-XXX 编号，依次追加输出。每个需求的格式相同，Checklist 从 C-001 重新开始计数。如存在依赖关系，需在标题中标注 `(deps: T-xxx, T-xxx)`。

## 输出示例

**示例：按开发顺序拆解较大需求**

假设用户输入："创建一个新的项目详情页面，包含项目基本信息展示、成员管理、设置三个功能模块"

这是一个较大的需求，应该按照开发顺序拆解成多个小任务：

```markdown
# T-001 创建项目详情页面路由和占位页面

## 需求描述

**Infrastructure：创建路由和占位页面**
- 创建项目详情页面的路由配置和占位页面组件
- 为后续功能开发提供基础框架

## 相关指引

前端规则:
- `.project-rules/frontend/architecture.md` - 了解路由配置和页面组件结构

前端Code Point:
- `webserver/frontend/router/` - 路由配置文件
- `webserver/frontend/feature/project-detail/` - 项目详情页面代码

前端路由:
- `/projects/:id` - 项目详情路由

## 注意点

- 路由参数需要正确配置，支持项目 ID
- 占位页面应该包含基础的布局结构

## Checklist

- [ ] C-001 路由配置正确，可以通过 URL 访问项目详情页面
- [ ] C-002 占位页面组件创建完成，包含基础布局结构
- [ ] C-003 页面可以正确接收和解析路由参数（项目 ID）

# T-002 实现项目详情页面跳转功能 (deps: T-001)

## 需求描述

**Feature：实现页面跳转**
- 在项目列表页面添加跳转到项目详情页面的功能
- 确保跳转时正确传递项目 ID

## 相关指引

前端Code Point:
- `webserver/frontend/feature/project-list/` - 项目列表页面代码

前端路由:
- `/projects` - 项目列表路由
- `/projects/:id` - 项目详情路由

## Checklist

- [ ] C-001 项目列表页面可以点击跳转到项目详情页面
- [ ] C-002 跳转时正确传递项目 ID
- [ ] C-003 浏览器前进后退功能正常工作

# T-003 实现项目基本信息展示功能 (deps: T-001, T-002)

## 需求描述

**Feature：项目基本信息展示**
- 在项目详情页面展示项目基本信息（名称、描述、创建时间、状态等）
- 从后端 API 获取项目数据并展示

## 相关指引

前端Code Point:
- `webserver/frontend/feature/project-detail/` - 项目详情页面代码

后端Code Point:
- `webserver/backend/api/projects.py` - 项目详情 API

## 注意点

- 需要处理数据加载状态和失败情况

## Checklist

- [ ] C-001 页面可以正确获取项目基本信息
- [ ] C-002 项目基本信息正确展示
- [ ] C-003 数据加载时显示 loading 状态
- [ ] C-004 数据加载失败时显示错误提示

# T-004 实现项目成员管理功能 (deps: T-001, T-002)

## 需求描述

**Feature：项目成员管理**
- 展示项目成员列表
- 支持添加成员、移除成员功能

## 相关指引

前端Code Point:
- `webserver/frontend/feature/project-detail/component/member-management.tsx` - 成员管理组件

后端Code Point:
- `webserver/backend/api/projects/members.py` - 成员管理 API

## 注意点

- 需要处理权限控制（只有管理员可以操作）

## Checklist

- [ ] C-001 成员列表正确展示
- [ ] C-002 可以添加新成员
- [ ] C-003 可以移除现有成员
- [ ] C-004 权限控制正确

# T-005 实现项目设置功能 (deps: T-001, T-002)

## 需求描述

**Feature：项目设置**
- 支持修改项目名称、描述等基本信息
- 支持项目删除功能

## 相关指引

前端Code Point:
- `webserver/frontend/feature/project-detail/component/project-settings.tsx` - 项目设置组件

后端Code Point:
- `webserver/backend/api/projects/settings.py` - 项目设置 API

## 注意点

- 修改项目信息需要表单验证
- 删除项目需要二次确认

## Checklist

- [ ] C-001 可以修改项目名称和描述
- [ ] C-002 表单验证正确
- [ ] C-003 可以删除项目，删除时有二次确认
- [ ] C-004 权限控制正确
```

## 注意事项

1. **⚠️ 用户确认优先（最重要）**：必须等待用户确认完所有不明确的地方后才能编写文档，不允许基于假设或推测直接编写文档

2. **⚠️ 细粒度拆解（核心原则）**：
   - **每个 Task 必须聚焦在一个单独的小功能上**
   - 对于较大需求，必须按照开发顺序拆解成多个小任务
   - 典型的拆解顺序：基础设施（路由、占位）→ 基础功能（跳转、数据获取）→ 核心功能（功能A、功能B、功能C）→ 增强功能（优化、边界处理）
   - 每个任务应该可以在 1-2 天内完成，有明确的输入和输出
   - 任务之间可以存在依赖关系，但依赖关系要清晰明确，并在标题中标注

3. **追加模式**：始终追加内容到 `.doc/dev.md`，不要覆盖已有内容

4. **文件创建**：如果 `.doc/dev.md` 不存在，需要先创建 `.doc` 目录和文件；如果用户描述中包含图片，需要创建 `.doc/dev-images/` 目录

5. **编号规则**：
   - 任务编号（T-XXX）：每个新需求使用递增的任务编号，需要读取现有文件确定下一个编号
   - Checklist 编号（C-XXX）：每个需求的 Checklist 从 C-001 开始重新计数
   - **拆分需求**：如果需求被拆分成多个独立需求，每个需求使用独立的 T-XXX 编号，依次递增
   - **依赖关系**：拆分后的需求可以存在依赖关系，如有依赖需在标题中标注 `(deps: T-xxx, T-xxx)`

6. **其他**：保持输出格式的一致性；根据需求复杂度调整详细程度；遵循项目的开发规范和架构原则；侧重于需求描述，不要添加代码层级细节；完整查看前后端相关实现来梳理现有逻辑

## 执行检查清单

在执行 specify 命令时，确保完成以下步骤：

- [ ] 解析用户输入，识别所有需求点和资源（链接、图片）
- [ ] 如果包含图片，下载并保存到 `.doc/dev-images/` 目录（使用 T-XXX 命名规则）
- [ ] 搜索并理解相关代码
- [ ] 识别不明确的地方，向用户提问并等待用户回答，确认所有不明确的地方都已得到明确回答后才能继续
- [ ] **评估需求复杂度，判断是否需要拆分成多个独立需求**
  - [ ] 对于较大需求，必须按照开发顺序拆解（基础设施 → 基础功能 → 核心功能 → 增强功能）
  - [ ] 确保每个任务聚焦在一个单独的小功能上，可以在 1-2 天内完成
  - [ ] 明确任务之间的依赖关系，并在标题中标注
- [ ] 读取 `.doc/dev.md` 确定下一个任务编号（T-XXX）
- [ ] 处理链接和图片资源，确定相关指引文档和代码路径
- [ ] 识别注意点和潜在风险，为每个需求生成详细的 Checklist（使用 C-001, C-002 等编号）
- [ ] 追加输出到 `.doc/dev.md`（格式正确，包含 T-XXX 和 C-XXX 编号）
- [ ] 确认拆解粒度合适，输出内容完整且准确

